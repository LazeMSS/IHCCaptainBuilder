name: CustoPiZe
'on':
  workflow_dispatch:
    inputs:
      input_image:
        description: "The base image to use as input for CustoPiZer"
        required: true
        default: "https://downloads.raspberrypi.org/raspios_lite_armhf/images/raspios_lite_armhf-2023-02-22/2023-02-21-raspios-bullseye-armhf-lite.img.xz"
jobs:
  build:
    name: "Build"
    runs-on: ubuntu-latest
    steps:
      - name: "🛒 Checkout repo"
        uses: actions/checkout@v3

      - name: "⬇️ Download Raspberry Pi OS Lite"
        run: |
          filename=$(basename "${{ github.event.inputs.input_image }}")
          echo $filename
          echo "${filename##*.}"
          exit 1
          mkdir build
          cd build
          
          curl -q -L -o image.xz ${{ github.event.inputs.input_image }}

          xz -d image.xz

          mv image input.img

      - name: "🏃 Run CustoPiZer"
        uses: OctoPrint/CustoPiZer@main
        with:
          workspace: '${{ github.workspace }}/build'
          scripts: '${{ github.workspace }}/scripts'
          environment: '{ "INSIDEGITHUB": "true" }'

      - name: "📦 Package the image"
        uses: OctoPrint/actions/package-rpi-image@main
        id: package-image
        with:
          image_path: '${{ github.workspace }}/build/output.img'

      - name: "⬆️ Upload Artifact"
        uses: actions/upload-artifact@v3
        with: 
          path: ${{ github.workspace }}/build/${{ steps.package-image.outputs.zip_name }}
